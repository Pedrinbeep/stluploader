//=========== Stl Viewer v1.09, by Omri Rips, Viewstl.com ; admin@viewstl.com ===========
function StlViewer(e,o){e||console.log("error: no parent element");var t=this;this.error=null,this.options=o,this.parent_element=e,this.get_opt=function(e,o){return t.options?!1!==t.options[e]&&(t.options[e]?t.options[e]:o):o},this.canvas_width="100%",this.canvas_height="100%",this.bg_color="transparent",this.models_to_add=null,this.models=new Array,this.models_count=0,this.models_ref=new Array,this.allow_drag_and_drop=t.get_opt("allow_drag_and_drop",t.allow_drag_and_drop),this.model_loaded_callback=null,this.all_loaded_callback=null,this.load_error_callback=null,this.loading_progress_callback=null,this.max_model_id=0,this.load_status=new Array,this.load_session=0,this.loaded_models_arr=new Array,this.status=0,this.onmousedown_callback=null,this.zoom=-1,this.camerax=0,this.cameray=0,this.cameraz=0,this.auto_rotate=!1,this.mouse_zoom=!0,this.load_three_files=t.get_opt("load_three_files",""),this.ready="undefined"!=typeof THREE,this.ready_callback=null,this.auto_resize=!0,this.on_model_drop=null,this.center_models=!0,this.controls_type=0,this.zoom=-1,this.pre_loaded_ab_files=null,this.pre_loaded_vsj=null,this.zip_load_count=-1,this.set_on_model_mousedown=function(e){t.onmousedown_callback=e,t.parent_element.onmousedown=e?t.onmousedown:null},this.set_drag_and_drop=function(e){e?(t.parent_element.addEventListener("dragover",t.handleDragOver),t.parent_element.addEventListener("drop",t.handleFileDrop)):(t.parent_element.removeEventListener("dragover",t.handleDragOver),t.parent_element.removeEventListener("drop",t.handleFileDrop))},this.set_options=function(){t.canvas_width=t.get_opt("width",t.canvas_width),t.canvas_height=t.get_opt("height",t.canvas_height),t.bg_color=t.get_opt("bgcolor",t.bg_color),t.models_to_add=t.get_opt("models",t.models_to_add),t.model_loaded_callback=t.get_opt("model_loaded_callback",t.model_loaded_callback),t.all_loaded_callback=t.get_opt("all_loaded_callback",t.all_loaded_callback),t.load_error_callback=t.get_opt("load_error_callback",t.load_error_callback),t.loading_progress_callback=t.get_opt("loading_progress_callback",t.loading_progress_callback),t.onmousedown_callback=t.get_opt("on_model_mousedown",t.onmousedown_callback),t.zoom=t.get_opt("zoom",t.zoom),t.camerax=t.get_opt("camerax",t.camerax),t.cameray=t.get_opt("cameray",t.cameray),t.auto_rotate=t.get_opt("auto_rotate",t.auto_rotate),t.mouse_zoom=t.get_opt("mouse_zoom",t.mouse_zoom),t.ready_callback=t.get_opt("ready_callback",null),t.auto_resize=t.get_opt("auto_resize",t.auto_resize),t.on_model_drop=t.get_opt("on_model_drop",t.on_model_drop),t.center_models=t.get_opt("center_models",t.center_models),t.controls_type=t.get_opt("controls",t.controls_type),t.zoom>=0?t.cameraz=t.zoom:t.cameraz=t.get_opt("cameraz",t.cameraz),t.allow_drag_and_drop&&t.set_drag_and_drop(!0),t.set_on_model_mousedown(t.onmousedown_callback)},t.is_ie=!!window.MSStream,this.MSG2WORKER_DATA=0,this.MSG2WORKER_LOAD=1,this.MSG2WORKER_ERROR=2,this.MSGFROMWORKER_STL_LOADED=3,this.MSGFROMWORKER_LOAD_IN_PROGRESS=4,this.load_model=function(e,o){return o=o||!1,t.max_model_id=Math.max(t.max_model_id,e.id),o||t.models_count++,e.filename||e.local_file?t.load_from_stl_file(e,!1):e.mesh?t.add_from_existing_mesh(e):void t.models_count--},this.add_from_existing_mesh=function(e){t.set_model_custom_props(e),e.mesh.model_id=e.id,t.set_geo_minmax(e),t.recalc_dims(e),t.scene.add(e.mesh),t.model_loaded(e.id),t.check_loading_status(e,0,0),e.mesh.geometry.boundingBox||e.mesh.geometry.computeBoundingBox(),t.model_loaded_callback&&t.model_loaded_callback(e.id)},this.load_from_stl_file=function(e){var o=new Worker(("string"==typeof t.load_three_files?t.load_three_files:"")+"load_stl.min.js");o.onmessage=function(a){switch(a.data.msg_type){case t.MSGFROMWORKER_STL_LOADED:e.colors=a.data.colors;var i=t.vf_to_geo(a.data.vertices,a.data.faces,!!a.data.colors&&a.data.colors);if(i){var s=new THREE.MeshLambertMaterial({color:9474192,overdraw:1,wireframe:!1,vertexColors:e.color?THREE.NoColors:THREE.FaceColors});t.is_ie||(s.side=THREE.DoubleSide),e.display||(e.display="flat"),t.set_material_display(e.display,s,i),e.mesh=new THREE.Mesh(i,s),t.set_model_custom_props(e),t.set_geo_minmax(e),e.mesh.model_id=e.id,t.recalc_dims(e),t.scene.add(e.mesh),t.model_loaded(e.id),t.model_loaded_callback&&t.model_loaded_callback(e.id)}else console.log("Error VF data ");o.terminate(),o=void 0,t.pre_loaded_ab_files&&e.filename&&t.pre_loaded_ab_files[e.filename]&&delete t.pre_loaded_ab_files[e.filename];break;case t.MSGFROMWORKER_LOAD_IN_PROGRESS:t.check_loading_status(e,a.data.loaded,a.data.total);break;case t.MSG2WORKER_ERROR:t.models_count--,t.model_error("ERROR: "+a.data.data,t.load_error_callback),t.pre_loaded_ab_files&&e.filename&&t.pre_loaded_ab_files[e.filename]&&delete t.pre_loaded_ab_files[e.filename]}},e.bytes_loaded=0,e.bytes_total=0;var a=null;t.pre_loaded_ab_files&&e.filename&&t.pre_loaded_ab_files[e.filename]&&(a=t.pre_loaded_ab_files[e.filename]),o.postMessage({msg_type:t.MSG2WORKER_DATA,data:e,load_from_blob:a,get_progress:null!=t.loading_progress_callback}),o.postMessage({msg_type:t.MSG2WORKER_LOAD})},this.model_loaded=function(e){t.loaded_models_arr[e]=1,Object.keys(t.loaded_models_arr).length>=t.models_count&&(t.set_zoom(),t.set_light(),t.load_session++,t.all_loaded_callback&&t.all_loaded_callback())},this.remove_model=function(e){if(void 0===t.models_ref[e])return t.model_error("remove_model - id not found: "+e);var o=t.models[t.models_ref[e]];o&&(delete t.models[t.models_ref[e]],delete t.models_ref[e],t.loaded_models_arr.splice(e,1),t.models_count=Object.keys(t.models).length,t.scene.remove(o.mesh))},this.zoom_done=!1,this.set_zoom=function(e,o){if(e&&(t.zoom=e),!(t.zoom_done&&!o&&t.zoom>=0)){t.zoom_done=!0;var a=Math.max(2*t.maxx,2*t.maxy,t.maxz);t.camera.position.set(t.camera.position.x,t.camera.position.y,t.zoom>=0?t.zoom:1.2*a*Math.max(1,t.camera.aspect/2))}},this.set_center_models=function(e){t.center_models=e},this.set_light=function(){t.directionalLight.position.x=2*t.maxy,t.directionalLight.position.y=2*t.miny,t.directionalLight.position.z=2*t.maxz,t.pointLight.position.x=(t.miny+t.maxy)/2,t.pointLight.position.y=(t.miny+t.maxy)/2,t.pointLight.position.z=2*t.maxz},this.stop_auto_zoom=function(){t.zoom=t.camera.position.z},this.set_camera=function(e,o,a){o&&(t.zoom=o),t.camera.position.set(t.is_empty(e)?t.camera.position.x:e,t.is_empty(o)?t.camera.position.y:o,t.zoom>=0?t.zoom:Math.max(3*t.maxx,3*t.maxy,3.5*t.maxz))},this.set_auto_zoom=function(){t.set_zoom(-1)},this.check_loading_status=function(e,o,a){e&&(t.load_status[e.id]={loaded:o,total:a,load_session:t.load_session}),t.loading_progress_callback&&Object.keys(t.load_status).length==t.models_count&&t.loading_progress_callback(t.load_status,t.load_session)},this.set_edges=function(e,o){if(void 0===t.models_ref[e])return t.model_error("set_edges - id not found: "+e);var a=t.models[t.models_ref[e]];a&&t.set_or_update_geo_edges(a,o)},this.set_or_update_geo_edges=function(e,o,a){if(o&&!a||(e.edges&&t.scene.remove(e.edges),e.edges=null,o)){var i=!1;if(a=a||!1,!e.edges||a){var s=e.mesh.geometry;e.edges=new THREE.LineSegments(new THREE.EdgesGeometry(s),t.edges_material),i=!0}(e.x||e.y||e.z)&&e.edges.position.set(e.x?e.x:0,e.y?e.y:0,e.z?e.z:0),e.edges.rotation.setFromRotationMatrix(e.mesh.matrix),i&&t.scene.add(e.edges)}},this.set_model_custom_props=function(e){e.x=e.x?e.x:0,e.y=e.y?e.y:0,e.z=e.z?e.z:0,e.mesh.position.set(e.x,e.y,e.z),e.color?t.update_mesh_color(e.mesh,e.color,!1):e.colors&&t.update_mesh_color(e.mesh,"#FFFFFF",!0),e.rotationx=e.rotationx?e.rotationx:0,e.rotationy=e.rotationy?e.rotationy:0,e.rotationz=e.rotationz?e.rotationz:0,(e.rotationx||e.rotationy||e.rotationz)&&this.rotate(e.id,e.rotationx,e.rotationy,e.rotationz);var o=void 0!==e.scale?e.scale:1,a=void 0!==e.scalex?e.scalex:o,i=void 0!==e.scaley?e.scaley:o,s=void 0!==e.scalez?e.scalez:o;e.scalex=a,e.scaley=i,e.scalez=s,1==a&&1==i&&1==s||t.scale_geo(e.mesh.geometry,a,i,s),e.view_edges&&t.set_or_update_geo_edges(e,!0),e.opacity&&this.set_material_opacity(e.mesh.material,e.opacity),e.animation&&(t.animation[e.id]=1)},this.set_scale=function(e,o,a,i){if(void 0===t.models_ref[e])return t.model_error("set_scale - id not found: "+e);var s=t.models[t.models_ref[e]];if(s&&s.mesh&&s.mesh.geometry){var n=Math.max(s.scalex,.01),l=Math.max(s.scaley,.01),r=Math.max(s.scalez,.01);o&&(s.scalex=Math.max(o,.01)),s.scaley=Math.max(a||o,.01),s.scalez=Math.max(i||o,.01),t.scale_geo(s.mesh.geometry,s.scalex/n,s.scaley/l,s.scalez/r),s.edges&&t.set_or_update_geo_edges(s,!0,!0)}},this.scale_geo=function(e,o,t,a){e.scale(o,t,a)},this.recalc_dims=function(e){var o=e.mesh.geometry;t.maxx=t.maxx?Math.max(t.maxx,o.maxx+e.x):o.maxx+e.x,t.maxy=t.maxy?Math.max(t.maxy,o.maxy+e.y):o.maxy+e.y,t.maxz=t.maxz?Math.max(t.maxz,o.maxz+e.z):o.maxz+e.z,t.minx=t.maxx?Math.min(t.minx,o.minx+e.x):o.minx+e.x,t.miny=t.maxy?Math.min(t.miny,o.miny+e.y):o.miny+e.y,t.minz=t.maxz?Math.min(t.minz,o.minz+e.z):o.minz+e.z},this.update_mesh_color=function(e,o,t){null!=e&&("transparent"!=o?(e.traverse(function(e){e.visible=!0}),e.material.vertexColors=t?THREE.FaceColors:THREE.NoColors,t&&!o&&(o="#FFFFFF"),o&&e.material.color.set(parseInt(o.substr(1),16)),e.material.needsUpdate=!0):e.traverse(function(e){e.visible=!1}))},this.set_color=function(e,o){if(void 0===t.models_ref[e])return t.model_error("set_color - id not found: "+e);var a=t.models[t.models_ref[e]];a&&a.mesh&&(a.color=o,t.update_mesh_color(a.mesh,o,!o&&a.colors))},this.error_in_model=function(e){if(!e.id&&0!=e.id&&-1!=e.id)return t.model_error("missing id");if(!Number.isInteger(e.id))return t.model_error("invalid id");if(e.id<-1)return t.model_error("id must be positive");if(!e.filename&&!e.mesh&&!e.local_file){if(!e.name)return t.model_error("missing filename or mesh");e.filename=e.name}return t.models_ref[e.id]?t.model_error("such model ID already exists: "+e.id):null},this.model_error=function(e,o){return console.log(e),t.status=-1,t.error=e,o&&o(e),e},this.set_bg_color=function(e){"transparent"==e?this.renderer.setClearColor(0,0):this.renderer.setClearColor(e,1)},this.set_display=function(e,o){if(void 0===t.models_ref[e])return t.model_error("set_display - id not found: "+e);var a=t.models[t.models_ref[e]];a&&(t.set_material_display(o,a.mesh.material,a.mesh.geometry),a.display=o,a.mesh&&(a.mesh.normalsNeedUpdate=!0))},this.set_opacity=function(e,o){if(void 0===t.models_ref[e])return t.model_error("set_display - id not found: "+e);var a=t.models[t.models_ref[e]];a&&this.set_material_opacity(a.mesh.material,o)},this.set_material_opacity=function(e,o){e&&(o<1?(e.opacity=o,e.transparent=!0):(e.opacity=1,e.transparent=!1))},this.onmousedown=function(e){e.preventDefault(),t.mouse.x=(e.clientX-t.parent_element.offsetLeft)/t.parent_element.clientWidth*2-1,t.mouse.y=-(e.clientY-t.parent_element.offsetTop)/t.parent_element.clientHeight*2+1,t.raycaster.setFromCamera(t.mouse,t.camera);var o=t.raycaster.intersectObjects(t.scene.children);if(o.length>0){if(void 0===o[0].object.model_id)return;t.onmousedown_callback&&t.onmousedown_callback(o[0].object.model_id)}},this.is_empty=function(e){return!e&&0!==e},this.set_position=function(e,o,a,i){if(void 0===t.models_ref[e])return t.model_error("set_position - id not found: "+e);var s=t.models[t.models_ref[e]];s&&s.mesh&&(s.x=t.is_empty(o)?s.x:o,s.y=t.is_empty(a)?s.y:a,s.z=t.is_empty(i)?s.z:i,s.mesh.position.set(s.x,s.y,s.z),s.edges&&t.set_or_update_geo_edges(s,!0,!0))},this.set_material_display=function(e,o,t){switch(e.toLowerCase()){case"wireframe":o.wireframe=!0;break;case"smooth":o.wireframe=!1,o.shading=THREE.SmoothShading,t&&(t.mergeVertices(),t.computeVertexNormals());break;case"flat":o.wireframe=!1,o.shading=THREE.FlatShading,t&&t.computeFlatVertexNormals()}},this.rotate=function(e,o,a,i){if(void 0===t.models_ref[e])return t.model_error("rotate - id not found: "+e);var s=t.models[t.models_ref[e]];s&&(o&&t.rotateAroundWorldAxis(s.mesh,t.WORLD_X_VECTOR,o),a&&t.rotateAroundWorldAxis(s.mesh,t.WORLD_Y_VECTOR,a),i&&t.rotateAroundWorldAxis(s.mesh,t.WORLD_Z_VECTOR,i),s.edges&&t.set_or_update_geo_edges(s,!0))},this.rotateAroundWorldAxis=function(e,o,t){var a=new THREE.Matrix4;a.makeRotationAxis(o,t),a.multiply(e.matrix),e.matrix=a,e.rotation.setFromRotationMatrix(e.matrix)},this.add_model=function(e,o){if(Array.isArray(e))return t.add_models(e);if(!t.ready)return t.models_to_add.push(e),t.model_error("THREE JS files are not ready");void 0===e.id&&(e.id=-1);var a=t.error_in_model(e);if(a)return a;-1==e.id&&(e.id=++t.max_model_id),t.models.push(e);var i=t.models.indexOf(e);return t.models_ref[e.id]=i,t.load_model(e,o),t.status},this.add_models=function(e){return Array.isArray(e)?(t.status=0,Object.keys(e).forEach(function(o){void 0===t.models_ref[e[o].id]&&t.models_count++,t.add_model(e[o],!0)}),t.status):t.add_model(e)},this.calc_volume_and_area=function(e){var o,t,a,i,s,n,l,r,d,_,c,m,f,h,u=e.faces.length,p=0,y=0;for(_=0;_<u;_++)o=e.vertices[e.faces[_].a].x,i=e.vertices[e.faces[_].a].y,l=e.vertices[e.faces[_].a].z,t=e.vertices[e.faces[_].b].x,s=e.vertices[e.faces[_].b].y,r=e.vertices[e.faces[_].b].z,p+=-(a=e.vertices[e.faces[_].c].x)*s*l+t*(n=e.vertices[e.faces[_].c].y)*l+a*i*r-o*n*r-t*i*(d=e.vertices[e.faces[_].c].z)+o*s*d,h=((c=e.vertices[e.faces[_].a].distanceTo(e.vertices[e.faces[_].b]))+(m=e.vertices[e.faces[_].b].distanceTo(e.vertices[e.faces[_].c]))+(f=e.vertices[e.faces[_].c].distanceTo(e.vertices[e.faces[_].a])))/2,y+=Math.sqrt(h*(h-c)*(h-m)*(h-f));return[Math.abs(p/6),y,e.faces.length]},this.get_model_info=function(e){if(void 0===t.models_ref[e])return t.model_error("get_model_info - id not found: "+e);var o=t.models[t.models_ref[e]];if(!o)return null;if(!o.mesh)return null;if(!o.mesh.geometry)return null;var a=o.mesh.geometry?t.calc_volume_and_area(o.mesh.geometry):[0,0,0];return{name:o.filename?o.filename:o.local_file?o.local_file.name:"",orig_filename:o.orig_filename?o.orig_filename:null,position:{x:o.x,y:o.y,z:o.z},dims:{x:o.mesh.geometry.maxx-o.mesh.geometry.minx,y:o.mesh.geometry.maxy-o.mesh.geometry.miny,z:o.mesh.geometry.maxz-o.mesh.geometry.minz},rotation:{x:o.mesh.rotation.x,y:o.mesh.rotation.y,z:o.mesh.rotation.z},display:o.display?o.display:null,color:o.color?o.color:null,scale:{x:o.scalex,y:o.scaley,z:o.scalez},volume:a[0],area:a[1],triangles:a[2]}},this.get_vsb=function(){var e=[];return Object.keys(t.models_ref).forEach(function(o){e.push({id:t.models_ref[o],bin:t.get_stl_bin(t.models_ref[o])})}),{vsj:t.get_vsj(!0),files:e}},this.get_vsj=function(e){var o={canvas_height:t.canvas_height,bg_color:t.bg_color,zoom:t.zoom,camerax:t.camerax,cameray:t.cameray,auto_rotate:t.auto_rotate,mouse_zoom:t.mouse_zoom,auto_resize:t.auto_resize,center_models:t.center_models,controls_type:t.controls_type,models:[]};return Object.keys(t.models_ref).forEach(function(e){var a=t.models[t.models_ref[e]],i={id:t.models_ref[e]};a.filename&&(i.filename=a.filename),a.local_file&&(i.local_file=a.local_file),a.x&&(i.x=a.x),a.y&&(i.y=a.y),a.z&&(i.z=a.z),a.display&&(i.display=a.display),a.color&&(i.color=a.color),a.rotationx&&(i.rotationx=a.rotationx),a.rotationy&&(i.rotationy=a.rotationy),a.rotationz&&(i.rotationz=a.rotationz),void 0!==a.scale&&1!=a.scale&&(i.scale=a.scale),1!=a.scalex&&(i.scalex=a.scalex),1!=a.scaley&&(i.scaley=a.scaley),1!=a.scalez&&(i.scalez=a.scalez),void 0!==a.opacity&&1!=a.opacity&&(i.opacity=a.opacity),a.view_edges&&(i.view_edges=a.view_edges),a.animation&&(i.animation=JSON.parse(JSON.stringify(a.animation)),delete i.animation.start_time,delete i.animation.last_time),o.models.push(i)}),e?o:JSON.stringify(o)},this.download_vsj=function(e,o){if(void 0===t.models_ref[e])return t.model_error("download_vsj - id not found: "+e);var a=t.models[t.models_ref[e]];if(a&&a.mesh){var i=new Blob([t.get_vsj(e)],{type:"application/json"}),s=document.createElement("a");s.href=window.URL.createObjectURL(i);var n=o||(a.filename?a.filename:a.local_file?a.local_file.name:"1"),l=n.toLowerCase().indexOf(".stl");l>=0&&(n=n.substring(0,l)),n.length<1&&(n="1"),s.download=n+".vsj",s.click()}},this.load_vsj=function(e){if(!e)return!!t.pre_loaded_vsj&&(stl_viewer.init_by_json(t.pre_loaded_vsj),t.pre_loaded_vsj=null,!0);var o=new XMLHttpRequest;o.onreadystatechange=function(e){4==o.readyState&&200==o.status&&stl_viewer.init_by_json(o.response.trim())},o.open("GET",e,!0),o.send(null)},this.padend=function(e,o,t){return o>>=0,t=String(void 0!==t?t:" "),e.length>o?String(e):((o-=e.length)>t.length&&(t+=t.repeat(o/t.length)),String(e)+t.slice(0,o))},this.get_normal=function(e,o,t){var a=o.x-e.x,i=o.y-e.y,s=o.z-e.z,n=t.x-e.x,l=t.y-e.y,r=t.z-e.z,d={x:0,y:0,z:0};d.x=i*r-s*l,d.y=s*n-a*r,d.z=a*l-i*n;var _=Math.sqrt(d.x*d.x+d.y*d.y+d.z*d.z);return 0!=_&&(d.x/=_,d.y/=_,d.z/=_),d},this.get_stl_bin=function(e){if(void 0===t.models_ref[e])return t.model_error("get_stl_bin - id not found: "+e);var o=t.models[t.models_ref[e]];if(o&&o.mesh){var a=o.mesh.geometry;if(a){for(var i=new ArrayBuffer(84+50*a.faces.length),s=new DataView(i),n=(new TextEncoder,t.padend("Binary"+(o.colors?" colored":"")+" STL by viewstl.com",80," ")),l=0;l<80;l++)s.setUint8(l,n.charCodeAt(l),!0);s.setUint32(80,a.faces.length,!0);var r=84;return Object.keys(a.faces).forEach(function(e){var i=a.faces[e],n=a.vertices[i.a],l=a.vertices[i.b],d=a.vertices[i.c],_=t.get_normal(n,l,d);s.setFloat32(r,_.x,!0),r+=4,s.setFloat32(r,_.y,!0),r+=4,s.setFloat32(r,_.z,!0),r+=4,s.setFloat32(r,n.x,!0),r+=4,s.setFloat32(r,n.y,!0),r+=4,s.setFloat32(r,n.z,!0),r+=4,s.setFloat32(r,l.x,!0),r+=4,s.setFloat32(r,l.y,!0),r+=4,s.setFloat32(r,l.z,!0),r+=4,s.setFloat32(r,d.x,!0),r+=4,s.setFloat32(r,d.y,!0),r+=4,s.setFloat32(r,d.z,!0),r+=4,o.colors?s.setUint16(r,Math.ceil(31*i.color.r)|Math.ceil(31*i.color.g)<<5|Math.ceil(31*i.color.b)<<10,!0):s.setUint16(r,0,!0),r+=2}),i}}},this.download_vsb=function(e){var o=null;try{o=new JSZip}catch(e){return console.log("download_vsb - JSZip is missing ",e.message),!1}var a=t.get_vsb();o.file("json_data.vsj",JSON.stringify(a.vsj)),Object.keys(a.files).forEach(function(e){o.file(a.vsj.models[a.files[e].id].filename,a.files[e].bin)}),o.generateAsync({type:"blob"}).then(function(o){var t=new Blob([o],{type:"application/zip"}),a=document.createElement("a");a.href=window.URL.createObjectURL(t);var i=e||"1",s=i.toLowerCase().indexOf(".vsb");s>=0&&(i=i.substring(0,s)),i.length<1&&(i="1"),a.download=i+".vsb",a.click()})},this.load_vsb=function(e){t.pre_loaded_ab_files=[],t.pre_loaded_vsj=null,JSZipUtils.getBinaryContent(e,function(e,o){if(e)return console.log(e),!1;t.load_vsb_from_blob(o)})},this.load_vsb_from_blob=function(e){var o=null;try{o=new JSZip}catch(e){return console.log("load vsb - JSZip is missing ",e.message),!1}o.loadAsync(e).then(function(){t.zip_load_count=Object.keys(o.files).length,o.forEach(function(e,a){"json_data.vsj"==a.name?o.files[a.name].async("string").then(function(e){t.pre_loaded_vsj=e,t.zip_load_count--,0==t.zip_load_count&&t.load_vsj(null)}):o.files[a.name].async("blob").then(function(e){t.pre_loaded_ab_files[a.name]=e,t.zip_load_count--,0==t.zip_load_count&&t.load_vsj(null)})})})},this.download_model=function(e,o){if(void 0===t.models_ref[e])return t.model_error("download_model - id not found: "+e);var a=t.models[t.models_ref[e]];if(a&&a.mesh){var i=new Blob([t.get_stl_bin(e)],{type:"application/sla"}),s=document.createElement("a");s.href=window.URL.createObjectURL(i);var n=o||(a.filename?a.filename:a.local_file?a.local_file.name:"1"),l=n.toLowerCase().indexOf(".stl");l>=0&&(n=n.substring(0,l)),n.length<1&&(n="1"),s.download=n+".stl",s.click()}},this.get_model_mesh=function(e){if(void 0===t.models_ref[e])return t.model_error("get_model_mesh - id not found: "+e);var o=t.models[t.models_ref[e]];return o&&o.mesh?o.mesh.clone():void 0},this.set_auto_rotate=function(e){t.controls.autoRotate=e},this.set_mouse_zoom=function(e){t.controls.noZoom=!e},this.WORLD_X_VECTOR=null,this.WORLD_Y_VECTOR=null,this.WORLD_Z_VECTOR=null,this.maxx=null,this.maxy=null,this.maxz=null,this.minx=null,this.miny=null,this.minz=null,this.edges_material=null,this.raycaster=null,this.mouse=null,this.scene=null,this.is_webgl=null,this.renderer=null,this.camera=null,this.ambientLight=null,this.directionalLight=null,this.pointLight=null,this.controls=null,this.do_resize=function(){var e=t.parent_element.getBoundingClientRect(),o=e.width,a=e.height;t.camera.aspect=o/a,t.camera.updateProjectionMatrix(),t.renderer.setSize(o-5,a-5)},this.animation=new Array,this.animate=function(){Object.keys(t.animation).forEach(function(e){void 0!==t.models_ref[e]&&t.do_model_animation(t.models[t.models_ref[e]])}),requestAnimationFrame(t.animate),t.renderer.render(t.scene,t.camera),t.controls&&t.controls.update()},this.do_model_animation=function(e){if(e.animation){var o=Date.now();if(e.animation.start_time||(e.animation.start_time=o),e.animation.delta){var a=(o-e.animation.start_time)/e.animation.delta.msec,i=e.animation.last_time?(o-e.animation.last_time)/e.animation.delta.msec:a;if(t.animation_next_delta(e,e.animation.delta,i),a>=1){if(!e.animation.delta.loop)return void t.remove_model_animation(e,!0);e.animation.delta.start_time=null}}if(e.animation.exact){i=(o-(e.animation.last_time?e.animation.last_time:e.animation.start_time))/e.animation.exact.msec;if(t.animation_next_exact(e,e.animation.exact,i),o>=e.animation.start_time+e.animation.exact.msec)return void t.remove_model_animation(e,!1,!0)}e.animation.last_time=o}},this.animation_next_delta=function(e,o,a){var i=!1,s=!1,n=!1;Object.keys(o).forEach(function(l){switch(l){case"x":case"y":case"z":i||(i=!0,t.set_position(e.id,e.x+(void 0!==o.x?o.x*a:0),e.y+(void 0!==o.y?o.y*a:0),e.z+(void 0!==o.z?o.z*a:0)));break;case"rotationx":case"rotationy":case"rotationz":s||(s=!0,t.rotate(e.id,void 0!==o.rotationx?o.rotationx*a:0,void 0!==o.rotationy?o.rotationy*a:0,void 0!==o.rotationz?o.rotationz*a:0));break;case"scale":case"scalex":case"scaley":case"scalez":n||(n=!0,o.scalex=o.scalex?o.scalex:o.scale?o.scale:null,o.scaley=o.scaley?o.scaley:o.scale?o.scale:null,o.scalez=o.scalez?o.scalez:o.scale?o.scale:null,t.set_scale(e.id,e.scalex+(void 0!==o.scalex?o.scalex*a:0),e.scaley+(void 0!==o.scaley?o.scaley*a:0),e.scalez+(void 0!==o.scalez?o.scalez*a:0)))}})},this.animation_next_exact=function(e,o,a){var i=!1,s=!1,n=!1;Object.keys(o).forEach(function(l){switch(l){case"x":case"y":case"z":i||(i=!0,void 0===o.xtotal&&(o.xtotal=o.x-e.x),void 0===o.ytotal&&(o.ytotal=o.y-e.y),void 0===o.ztotal&&(o.ztotal=o.z-e.z),t.set_position(e.id,e.x+(void 0!==o.x?o.xtotal*a:0),e.y+(void 0!==o.y?o.ytotal*a:0),e.z+(void 0!==o.z?o.ztotal*a:0)));break;case"rotationx":case"rotationy":case"rotationz":if(!s){s=!0;var r=e.mesh.getWorldRotation();void 0===o.rotxtotal&&(o.rotxtotal=o.rotationx-r.x),void 0===o.rotytotal&&(o.rotytotal=o.rotationy-r.y),void 0===o.rotztotal&&(o.rotztotal=o.rotationz-r.z),t.rotate(e.id,void 0!==o.rotationx?o.rotxtotal*a:0,void 0!==o.rotationy?o.rotytotal*a:0,void 0!==o.rotationz?o.rotztotal*a:0)}break;case"scale":case"scalex":case"scaley":case"scalez":n||(n=!0,o.scalex=o.scalex?o.scalex:o.scale?o.scale:null,o.scaley=o.scaley?o.scaley:o.scale?o.scale:null,o.scalez=o.scalez?o.scalez:o.scale?o.scale:null,void 0===o.scalextotal&&(o.scalextotal=o.scalex-e.scalex),void 0===o.scaleytotal&&(o.scaleytotal=o.scaley-e.scaley),void 0===o.scaleztotal&&(o.scaleztotal=o.scalez-e.scalez),t.set_scale(e.id,e.scalex+(void 0!==o.scalex?o.scalextotal*a:0),e.scaley+(void 0!==o.scaley?o.scaleytotal*a:0),e.scalez+(void 0!==o.scalez?o.scaleztotal*a:0)))}})},this.remove_model_animation=function(e,o,a){o&&(e.animation.delta=null),a&&(e.animation.exact=null),e.animation.delta||e.animation.exact||(e.animation=null,delete t.animation[e.id])},this.animate_model=function(e,o){if(void 0===t.models_ref[e])return t.model_error("animate-model - id not found: "+e);var a=t.models[t.models_ref[e]];if(a){if(!o)return t.remove_model_animation(a,!0,!0);a.animation=JSON.parse(JSON.stringify(o)),a.animation.delta&&(a.animation.delta.msec||(a.animation.delta.msec=300)),a.animation.exact&&(a.animation.exact.msec||(a.animation.exact.msec=300)),t.animation[e]=1}},this.init_done=!1,this.init=function(){switch(t.init_done||(t.WORLD_X_VECTOR=new THREE.Vector3(1,0,0),t.WORLD_Y_VECTOR=new THREE.Vector3(0,1,0),t.WORLD_Z_VECTOR=new THREE.Vector3(0,0,1),t.edges_material=new THREE.LineBasicMaterial({color:0}),t.raycaster=new THREE.Raycaster,t.mouse=new THREE.Vector2,t.scene=new THREE.Scene,t.is_webgl=webgl_Detector.webgl,t.renderer=t.is_webgl?new THREE.WebGLRenderer({preserveDrawingBuffer:!0,alpha:!0}):new THREE.CanvasRenderer({alpha:!0}),t.camera=new THREE.PerspectiveCamera(45,1,.1,1e4),t.parent_element.appendChild(t.renderer.domElement),t.scene.add(t.camera),t.ambientLight=new THREE.AmbientLight(2105376),t.camera.add(t.ambientLight),t.directionalLight=new THREE.DirectionalLight(16777215,.75),t.directionalLight.position.x=1,t.directionalLight.position.y=1,t.directionalLight.position.z=2,t.directionalLight.position.normalize(),t.camera.add(t.directionalLight),t.pointLight=new THREE.PointLight(16777215,.3),t.pointLight.position.x=0,t.pointLight.position.y=-25,t.pointLight.position.z=10,t.camera.add(t.pointLight)),t.set_bg_color(t.bg_color),t.camera.position.set(t.camerax,t.cameray,t.cameraz),t.do_resize(),!1===t.mouse_zoom&&t.set_mouse_zoom(t.mouse_zoom),t.controls_type){case 1:t.controls=new THREE.TrackballControls(t.camera,t.renderer.domElement);break;default:t.controls=new THREE.OrbitControls(t.camera,t.renderer.domElement),t.controls.autoRotate=t.auto_rotate}t.models_to_add&&t.add_models(t.models_to_add),t.set_auto_resize(t.auto_resize),t.animate(),t.init_done=!0},this.set_auto_resize=function(e){t.do_resize&&(window.removeEventListener("resize",t.do_resize),e&&window.addEventListener("resize",t.do_resize))},this.vf_to_geo=function(e,o,a){if(!e)return null;if(!o)return null;var s=[],n=[],l=e.length;for(i=0;i<l;i++)s.push(new THREE.Vector3(e[i][0],e[i][1],e[i][2]));l=o.length;if(a)for(i=0;i<l;i++){var r=new THREE.Face3(o[i][0],o[i][1],o[i][2]);r.color.setRGB(o[i][3],o[i][4],o[i][5]),n.push(r)}else for(i=0;i<l;i++)n.push(new THREE.Face3(o[i][0],o[i][1],o[i][2]));var d=new THREE.Geometry;return d.vertices=s,d.faces=n,d.computeBoundingBox(),d.computeFaceNormals(),d.computeVertexNormals(),t.center_models&&d.center(d),d},this.set_geo_minmax=function(e){var o=e.mesh.geometry;if(o.boundingBox)o.minx=o.boundingBox.min.x,o.miny=o.boundingBox.min.y,o.minz=o.boundingBox.min.z,o.maxx=o.boundingBox.max.x,o.maxy=o.boundingBox.max.y,o.maxz=o.boundingBox.max.z;else{for(var t=o.vertices,a=t[0].x,i=t[0].y,s=t[0].z,n=t[0].x,l=t[0].y,r=t[0].z,d=t.length;d--;)t[d].x<a&&(a=t[d].x),t[d].y<i&&(i=t[d].y),t[d].z<s&&(s=t[d].z),t[d].x>n&&(n=t[d].x),t[d].y>l&&(l=t[d].y),t[d].z>r&&(r=t[d].z);o.minx=a+e.x,o.miny=i+e.y,o.minz=s+e.z,o.maxx=n+e.x,o.maxy=l+e.y,o.maxz=r+e.z}},this.handleDragOver=function(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"},this.handleFileDrop=function(e){if(e.stopPropagation(),e.preventDefault(),e.dataTransfer.files.length>0){for(var o=new Array,a=e.dataTransfer.files.length,i=0;i<a;i++)o.push({id:-1,local_file:e.dataTransfer.files[i]}),t.on_model_drop&&t.on_model_drop(e.dataTransfer.files[i].name);t.add_models(o)}else"string"==typeof e.dataTransfer.getData("Text")&&(t.add_model({id:-1,filename:e.dataTransfer.getData("Text")}),t.on_model_drop&&t.on_model_drop(e.dataTransfer.getData("Text")))},this.clean=function(){if(t.scene){var e=t.scene;for(i=e.children.length;i--;)"Mesh"===e.children[i].type&&e.remove(e.children[i]);t.camera.position.set(t.camerax,t.cameray,t.cameraz),t.models=new Array,t.models_count=0,t.models_ref=new Array,t.max_model_id=0,t.load_status=new Array,t.load_session=0,t.loaded_models_arr=new Array,t.animation=new Array}},this.reset_parent_element=function(e){t.parent_element=e,t.allow_drag_and_drop&&t.set_drag_and_drop(!0),t.set_on_model_mousedown(this.onmousedown_callback),t.parent_element.appendChild(t.renderer.domElement)},this.scripts_loader=null,this.external_files_loaded=function(){t.ready=!0,t.init(),t.ready_callback&&t.ready_callback()},this.load_three=function(e){"string"!=typeof t.load_three_files&&(t.load_three_files=""),t.scripts_loader=new ScriptsLoader,t.scripts_loader.load_scripts(new Array(e+"three.min.js",e+"webgl_detector.js",e+"Projector.js",e+"CanvasRenderer.js",e+(0==t.controls_type?"OrbitControls.js":"TrackballControls.js")),t.external_files_loaded)},this.init_by_json=function(e){var o=null;try{o=JSON.parse(e)}catch(o){return console.log("json error ",e),!1}t.options=o,t.set_options(),t.ready&&t.init()},t.set_options(),t.ready?(t.init(),t.ready_callback&&t.ready_callback()):!1!==t.load_three_files?t.load_three(t.load_three_files):t.model_error("No THREE files were loaded")}function ScriptsLoader(){var e=this;this.all_loaded_callback=null,this.scripts_to_load=new Array,this.loading_scripts=new Array,this.loaded_scripts=new Array,this.scripts_are_loaded=function(o){var t=Object.keys(o);for(i=t.length;i--;)if(!e.loaded_scripts[e.get_full_name(o[i])])return!1;return!0},this.get_short_name=function(e){return e?e.substring(e.lastIndexOf("/")+1):""},this.load_scripts=function(o,t){t&&(e.all_loaded_callback=t),Object.keys(o).forEach(function(t){var a=e.get_short_name(o[t]);-1==e.scripts_to_load.indexOf(a)&&(e.loading_scripts[a]||e.loaded_scripts[a]||e.scripts_to_load.push(o[t]))}),e.load_files()},this.load_files=function(){if(0!=e.scripts_to_load.length)for(;e.scripts_to_load.length;){var o=e.scripts_to_load.shift();if(!e.loading_scripts[o]){e.loading_scripts[o]=1;var t=document.createElement("script");return t.onload=function(){var o=e.get_short_name(t.src);e.loaded_scripts[o]=1,e.loading_scripts[o]=0,e.load_files()},t.src=o,void document.head.appendChild(t)}}else e.all_loaded_callback&&e.all_loaded_callback()}}Number.isInteger=Number.isInteger||function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e};